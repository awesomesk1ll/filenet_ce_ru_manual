# Наборы маркировок

Наборы маркировок позволяют назначить объекту дополнительную защиту, поверх той, которая задается [правами доступа](permissions.md). 
Будем считать, что "базовая защита" определяется свойством Permissions, и согласно ACL, хранящемся в этом свойстве, вычисляется права текущего пользователя на объект - некоторая битовая маска.

Однако если объект обладает маркировкой, то на базовую защиту накладывается модификатор, определяемый
* маской ограничения маркировки
* правами текущего пользователя на данную маркировку, а если точнее, правом пользователя "использовать" данную маркировку

Давайте рассмотрим пример. Пусть есть три группы пользователей:
* читатели
* редакторы
* администраторы

Пусть есть три маркировки:

1. "Полный доступ". Маска ограничения: нет. Могут использовать: все
2. "Чтение и редактирование". Маска ограничения: запретить удаление. Могут использовать: редакторы, администраторы
3. "Только чтение". Маска ограничения: запретить редактирование, запретить удаление. Могут использовать: админстраторы

Рассмотрим документ с маркировкой "Только чтение". Маркировку могут использовать только администраторы, значит, для них права на документ определяются своством Premissions. Читатели и редакторы теряют возможность редактровать и удалять документ.

На документ документ с "Полным доступом" все пользователи имеют свои "базовые права". Документ "Чтение и редактирование" не могут удалить читатели.

Набор маркировок - совокупность логически связанных маркировок, как в примере. Набор маркировок можно привязать к свойству типа String. Значение этого свойство считается текущей маркировкой объекта. 

Разумеется, значение свойства можно изменить на другую маркировку, и в таком случае модификатор защиты поменяется.
Также объект может иметь сразу несколько маркировок (если несколько его свойств привязаны к наборам маркировок). В этом случае, маски ограничения объединяются.

## Основные положения

* маркировка ([Marking](https://www.ibm.com/support/knowledgecenter/SSNW2F_5.2.0/com.ibm.p8.ce.dev.java.doc/com/filenet/api/security/Marking.html)) - объект, имеющий следующие свойства:
  * **MarkingValue** - значение маркировки (String). Это значение может принимать свойство, с которым связан набор маркировок (см. далее)
  * **Permissions** - список прав доступа (AccessPermissionList). ACL, которы участвует в вычислении прав доступа объекта, у которого установлена данная маркировка
  * **ConstraintMask** - маска ограничения (Integer) 
* набор маркировок ([MarkingSet](https://www.ibm.com/support/knowledgecenter/SSNW2F_5.2.1/com.ibm.p8.ce.dev.java.doc/com/filenet/api/security/MarkingSet.html)) - множество маркировок с разными значениями
* наборы маркировок определяются на уровне домена. Каждое хранилище в домене может использовать наборы домена. Домен (Domain) имеет свойство **MarkingSetSet** - коллекция, содержащая все наборы маркировок
* шаблон свойства типа String (PropertyTemplateString) имеет свойство **Marking** типа MarkingSet. Через это свойство можно связать шаблон с определенным набором маркировок 
* шаблон свойства имеет метод createClassProperty(), производящий определение свойства (ClassDefinition). Определение свойства может быть добавлено к определению класса (ClassDefinition). Соответсвенно, доступ к инстансам таких классов зависит уже не только от свойства Permissions, и от свойства типа String, которое было связано с набором маркировок

## Определение итоговой маски

Рассмотрим алгоритм получения итоговой маски, т.е. той, по которой CE предоставит доступ пользователю или группе к объекту:

1. Пользователь запрашивает доступ к объекту
2. По свойству Permissions CE вычисляет "маску, определяемую ACL"
3. По свойствам, связанным с наборами маркировок, вычисляется "маска, определяемая маркировками". Для её вычисления используются свойства Permissions заданных значений маркировок. Если пользователь отсутствует в ACL, используется ConstraintMask данной маркировки
4. Итоговая маска определяется как логическое умножение ("И") "маски, определяемой ACL" и "маски, определяемой маркировками"

## Типичный пример

Типичный пример использования маркировок - гриф документа. Маркировки этого набора иметь такие значения:

* **"Соверенно секретно"** - доступ только для высшего руководства
* **"Конфиденциально"** - доступ только для руководителей
* **"Внутренний"** - доступ для всех сотрудников комании
* **"Внешний"** - доступ для всех
